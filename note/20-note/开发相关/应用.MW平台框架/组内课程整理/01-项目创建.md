# 任务目标

使用现有的平台框架（通过nuget安装依赖），完成基础的项目搭建，并且能够正常程序

# 操作过程

## 1 创建工程

1. 创建基于`.Net Framework4.6.1 WPF工程`
2. 修改解决方案平台为X64
3. 修改项目输出路径为`..\Bin`

## 2 Nuget安装相关依赖

### 2.1 配置Nuget源

```Shell
maxwell = http://nas.maxwell-gp.com.cn:4994/v3/index.json
```

### 2.2 相关包说明

| 包名                              | 说明                                                                | 标注   |
| --------------------------------- | ------------------------------------------------------------------- | ------ |
| MaxwellControl                    | 基础控件库                                                          | base   |
| MaxwellFramework.AlarmManager     | Maxwell报警管理器                                                   | base   |
| MaxwellFramework.AnimationManager | Maxwell动画模块                                                     |        |
| MaxwellFramework.Core             | 主框架的核心库，包含了公共的接口、基类、一些帮助类，MVVM和IOC功能。 | base   |
| MaxwellFramework.PC               | 主程序框架PC版（支持分辨率1920X1080）                               | one    |
| MaxwellFramework.Touchable        | 主程序框架Touchable版（支持分辨率1024X1080）                        | one    |
| MwFramework.ATF                   | 自动对焦、测高、组件样式                                            |        |
| MwFramework.Base                  | 平台组件基础依赖文件                                                | base   | 
| MwFramework.Calib                 | 标定                                                                |        |
| MwFramework.Controls.Non-Touch    | 平台非触屏控件（支持分辨率1920X1080，面板版）                       |        |
| MwFramework.Controls.Touchable    | 平台触屏控件（支持分辨率1024X1080，半导体和微显版）                 |        |
| MwFramework.Controls.UIControl    | 平台触屏控件、配方、轴、IO等                                        | base   |
| MwFramework.DeviceModule          | 平台所有硬件dll及其依赖文件                                         | device |
| MwFramework.ImageViewer           | 相机、图形绘制                                                      |        |
| MwFramework.OmronPLCDriver        | 欧姆龙组件                                                          | device |
| MwFramework.Procedure             | 流程引擎模块                                                        |        |
| MwFramework.Tools                 | 平台硬件配置工具                                                    | device |

其中base标注的是必选项，one标注的任选其一，同样触屏和非触屏版本对于其他组件都是任选其一，device标注是和硬件相关的包

### 2.3 复制配置文件

`packages/MaxwellFramework.Touchable/tools`将这个目录下的所有文件复制到输出目录，也就是`../Bin`

具体文件包含

1. Configuration文件夹，其中Layout.xml文件主要控制显示的布局
2. Database文件夹，其中存储了用户数据信息
3. Language文件夹，其中xaml记录了多语言信息
4. DefaultConfig文件，记录默认加载的dll文件

注：可以把这些文件复制到项目路径中，并添加到项目里，生成操作设置为无，复制到输出目录改为始终复制，这样我们可以直接在项目中修改配置文件，而不需要到输出目录中修改。

##  3 程序配置

### 3.1 重写BootStrapper

在项目目录中新建文件`StartBootstrapper.cs`（名称随意），他需要继承平台框架中`Bootstrapper`类，需要重写的方法如下。

```csharp
using MaxwellFramework;
using MaxwellFramework.Core.Interfaces;
using StyletIoC;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Threading;
 
namespace MaxwellFrameworkTest
{
    public  class StartBootstrapper : Bootstrapper
    {
        protected override void OnStart()
        {  
            base.OnStart();
        }
        
        protected override void ConfigureIoC(IStyletIoCBuilder builder)
        {       
            base.ConfigureIoC(builder);
        }
        
        protected override void Configure()
        {
            // This is called after Stylet has created the IoC container, so this.Container exists, but before the
            // Root ViewModel is launched.
            // Configure your services, etc, in here          
            base.Configure();
        }
        
        protected override void OnLaunch()
        {
            // This is called just after the root ViewModel has been launched
            // Something like a version check that displays a dialog might be launched from here
 
            base.OnLaunch();
        }
 
        protected override void PrepareForInit(IProjectManager projectManager)
        {
            
        }
 
        protected override void OnExit(ExitEventArgs e)
        {         
            // Called on Application.Exit
            base.OnExit(e);
        }
        
        protected override void OnUnhandledException(DispatcherUnhandledExceptionEventArgs e)
        {           
            base.OnUnhandledException(e);
        }
    }
}
```

重写这个类可以在程序的生命周期中增加自己的逻辑，程序按照：Start->IoC配置->其他配置->运行->初始化准备->退出，执行一系列的流程。如果需要使用主程序框架的IoC，可以在ConfigureIoC方法中增加你的类型绑定。但需要注意的是，程序只会在生成目录中的一些特定的文件夹查找你的实现类型，如Plugins文件夹。

### 3.2 修改App.config

```XML
<?xml version="1.0" encoding="utf-8" ?>
<configuration>

     <!--放在最顶端-->
    <configSections>
        <section name="rules" type="System.Configuration.NameValueSectionHandler" />
    </configSections>
    
    <startup useLegacyV2RuntimeActivationPolicy="true">
        <supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.6.1" />
    </startup>
    
    <appSettings>
        <!--模拟硬件环境-->
        <add key="Demo" value="true"/>
        <!--语言-->
        <add key="Lang" value="CN" /> 
        <!--日志存储方式 Txt  DataBase DataBaseAndTxt-->
        <add key="SaveLogsWay" value="DataBase" />
        <!--Txt  存储路径-->
        <add key="LogsPath" value="Logs" />
    </appSettings>

    <!--日志过滤配置-->
    <rules>
         <add key="SocketModule" value="Error" />
     </rules>
        
</configuration>
```

### 3.3 修改app.xaml

```csharp
<Application x:Class="NewDemo.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:NewDemo"
             xmlns:mw="http://www.maxwell-gp.com/">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MaxwellControl;component/Themes/SkinTouchable.xaml" />
                <mw:ApplicationLoader>
                    <mw:ApplicationLoader.Bootstrapper>
                        <local:StartBootstrapper/>
                    </mw:ApplicationLoader.Bootstrapper>
                </mw:ApplicationLoader>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Application.Resources>
</Application>
```

### 3.4 配置`Configuration/Layout.xml`文件

```XML
<?xml version="1.0" encoding="utf-8"?>
<Layout Version="1.0.0" WindowHeight="1024" WindowWidth="1280"  MachineId="12345678901234567">
	<Header Title="FrameworkDemo">
		<HeaderItem Id="EMO"/>
		<HeaderItem Id="HideCIMStatus"/>
		<HeaderItem Id="HideLogger"/>
		<HeaderItem Id="HideAlarm"/>
		<HeaderItem Id="HideExit"/>
	</Header>
	<Body>
        <StatusBar>
            <StatusLight Name="设备一"  LangName="Device" Binding="Device"></StatusLight>
        </StatusBar>
        <Pages>
            <Page Name="主页" LangName="Home" Target="Home" ControlBarTarget="HomeControl"></Page>
            <Page Name="第二页" LangName="TwoPage">
                <Menu ItemContentOffset="20">
                    <MenuItem Name="二级页面"  LangName="TestSideMenu" ControlBarTarget="111" UserRightId="TestSideMenu">
                        <MenuItem Name="三级页面" LangName="PageThird" Target="Second" DisabledState="Test" ControlBarTarget="23"/>
                    </MenuItem>
                    <MenuItem Name="二级页面示例" LangName="SecondPageTest" Target="Test"/>
                </Menu>
            </Page>
        </Pages>
        <ToolBox Target="ToolBox"/>
	</Body>
	<Footer Target="Foot"/>
</Layout>
```

属性说明

1. Layout
    1. Version 不需要修改，默认即可
    2. WindowHeight 窗口高度
    3. WindowWidth 窗口宽度
    4. MachineId 机器码，默认即可
2. Header
    1. Title 项目名称，根据需求修改
    2. HeaderItem.Id 需要隐藏的模块
        1. EMO
        2. HideCIMStatus 隐藏CIM状态栏
        3. HideLogger 隐藏日志
        4. HideAlarm 隐藏警报
        5. HideExit 隐藏退出
3. StatusBar
    1. StatusLight
        1. Name 设备名称
        2. LangName 多语言名称
        3. Binding 对应的设备
4. Pages
    1. Page
        1. Name 页面名称
        2. LangName 多语言名称
        3. Target 绑定的页面
        4. ControlBarTarget 页面右边栏绑定组件
        5. DisabledState 禁用标识符，可以在代码中修改该标识符来动态的控制按钮
	    6. UserRightId 权限设置ID
        7. Menu 设置子页面
            1. MenuItem 子页面信息，属性同Page

## 4 添加语言支持

### 4.1 在Bootstrapper.cs中添加语言加载方法

```csharp
protected void LoadLanguage()
{
    // 获得语言类型
    //string lang = System.Configuration.ConfigurationManager.AppSettings["Lang"];
    string lang = "CN";
    // 添加平台语言包
    ResourceDictionary mwLang = new ResourceDictionary() { Source = new Uri("pack://siteoforigin:,,,/../Language/MaxwellFramework_" + lang.ToString() + ".xaml", UriKind.RelativeOrAbsolute) };
    Application.Current.Resources.MergedDictionaries.Add(mwLang);

    // 添加项目语言包,注意项目名称
    ResourceDictionary mxLang = new ResourceDictionary() { Source = new Uri("pack://siteoforigin:,,,/../Language/FrameworkDemo_" + lang.ToString() + ".xaml", UriKind.RelativeOrAbsolute) };
    Application.Current.Resources.MergedDictionaries.Add(mxLang);
}
```

并在OnStart()中引用

```csharp
protected override void OnStart()
{
    LoadLanguage();
    base.OnStart();
}
```

## 5 以管理员启动

当使用管理员启动vs时，可以直接使用调试按钮执行程序，输入密码000，最后可看到整个项目界面，默认的程序界面包含Header、Body、Footer三个部分，Header的title是应用程序的名称，Footer位于运行界面的右下角，Body包含StatusBar、Pages两个部分，StatusBar：状态栏（PC版，触摸屏版没有），用来显示硬件当前的状态，Pages是程序界面里包含的一些页面，可以用下方的对应按钮跳转到相应的页面上。

## 6 执行结果

![](https://cdn.jsdelivr.net/gh/Ailurus-2233/PicGo-ImageRepo@main/work-Image/202309071659489.png)

# 细节分析

## 1 为什么通过Bootstrapper就可以启动一个平台程序

## 2 Bootstrapper的声明周期流程有哪些

## 3 Stylet的IoC机制执行什么操作

## 4 平台框架的IoC机制执行了什么操作