---
title: 巨量转移中路径生成的解决方案
category: 巨量转移
tags:
  - 项目整理
  - 巨量转移
date: 2023-10-11
---
# 工作问题说明

在巨量转移的过程中，有这样一个需求，上基板(doner)与下基板(beneficiary)的形状为矩形大小不一致，需要生成晶粒(grain)的对应关系来构成晶粒的转移路径，其中上下基板的对应关系会比较复杂，因为上基板的晶粒密度可能会大于下基板对应颜色的晶粒密度，所以这里有两种思路来解决这个问题：
1. 一个上基板可以通过位移的方式作用于下基板的不同区域
2. 一个上基板的作用于多个下基板的同一个区域。

已知条件：
1. 上下基板之间存在一个不为1的最大公约数$x$，振镜的工作范围$d$，与其的关系为$kd=x$，其中$k$为正整数，这样子振镜的工作范围刚好可以覆盖上下基板的全部范围。
2. 上基板的晶粒间隔$I_d$与下基板的晶粒间隔$I_b$存在关系 $I_b = kI_d$，其中$k$为正整数，这样只需要对齐一次，并且指定晶粒列表即可将当前振镜区域的下基板晶粒一一配对，同样只需要调整对位就可以将上基板剩余晶粒作用于另一个下基板。

如图
1. 基板分部情况
![上基板分部情况|300](https://cdn.jsdelivr.net/gh/Ailurus-2233/PicGo-ImageRepo@main/work-Image/202310111433597.png)
2. 下基板分部情况
![image.png|300](https://cdn.jsdelivr.net/gh/Ailurus-2233/PicGo-ImageRepo@main/work-Image/202310111435319.png)

# 问题解决方案

## 总体思路

这里对于上下基板的关系采用第二种想法，一块上基板对应多个下基板的相同区域，通过上下对位完成不同上基板的晶粒转移

## 问题输入
1. 上基板数据（R，G，B）donerLMTData
	- 注：基板数据有宽度，高度，晶粒间隔X/Y，晶粒列表等
2. 下基板数据（R，G，B）beneficiaryLMTData
	- 注：虽然下基板是一个板子上三种颜色，但是为了方便区分以及和上基板对位，生成了三种不同颜色的下基板
3. 振镜工作区域 laserWidth
	- 注：振镜工作范围是一个方形区域，所以只输入了宽度
4. 区域内转移的起点 start
	- 注：起点是一个枚举类型，只有四个值，左上，右上，右下，左下
5. 区域内转移路径的方向 direction
	- 注：转移路径的类型是一个枚举类型，只有四个值，水平平行，垂直平行，水平S形，垂直S形

## 输出结果
对于每一种上基板输出一个图层区域的列表，列表中包含的数据有，图层编号，区域编号，上基板对位点，下基板对位点，上基板晶粒列表，下基板晶粒列表。

如图，路径规划结果
![image.png](https://cdn.jsdelivr.net/gh/Ailurus-2233/PicGo-ImageRepo@main/work-Image/202310111503148.png)

> [!info] 注
> 这里一个图层的意思为对于一上基板，只需对位一次能够转移的区域，不同图层则说明需要进行对位调整或者更换下基板区域。
> 
> 这里可能比较难理解，那就根据上图结果来说：
> 
> 在同一个图层中，有四个区域，原因是振镜的工作范围将上基板分为四个区域，其实只要一个区域对位完成，那么剩下的三个区域也是对齐的，不需要新的对位调整。
> 
> 而0号图层和1号图层会发现对应落点坐标是一样的，这对应着总体思路里面的描述，一块上基板对应多个下基板的相同区域，其实这两的图层是同一块上基板，只不过他能够为两个下基板的相同区域提供晶粒。
> 
> 而2号图层的落点已经发生了改变，则说明这是一块新的上基板为下基板新的区域提供晶粒。

## 解决流程

### version 1
1. 将上下基板的晶粒点位按照振镜的工作范围分为不同的组，将区域角点晶粒坐标与直角点坐标纪录（这部分代码使用原来人写的，直角点指的是四个角点距离基板中心最近的点位，用来标识这个区域的）
2. 计算一个下基板需要多少个上基板，水平方向需要$count_x$个，垂直方向需要$count_y$个
	- 注：一个下基板使用多个上基板平铺，直至上基板刚好能够覆盖下基板，计算方法如下
$$
\begin{aligned}
count_x = & \ Ceiling(Width_{b}/Width_{d}) \\
count_y = & \ Ceiling(Height_{b}/Height_{d}) \\
count = & \ count_x \times count_y
\end{aligned}
$$
3. 计算上下基板对应颜色的晶粒间隔倍数，水平方向倍数为$multiple_x$，垂直方向倍数为$multiple_y$。
	- 注：因为已知条件2，间隔倍数一定是整数倍，如果横向间隔和纵向间隔的倍数分别为$x$，$y$，那么一个上基板可以为$x \times y$个下基板提供晶粒
4. 按照$count_x$、$count_y$、$multiple_y$、$multiple_x$进行四层循环，对应循环数为$DX$、$DY$、$X$、$Y$，最里层的循环都会创建一个新的图层
	1. 获取相对mark点$mark_r$的坐标，这个mark点位的作用是计算每一个图层的偏移量，为之后获取区域内所有点位做支撑，计算方法如下
		$$
		\begin{aligned}
		mark_r.x = & mark_d.x + intervel_d.x \times X \\
		mark_r.y = & mark_d.y + intervel_d.y \times Y
		\end{aligned}
		$$
		其中，$mark_d$是上基板的mark点位，$intervel_d$是上基板的晶粒间隔，$X$为循环数对应$multiple_x$，$Y$为循环数对应$multiple_y$
	2. 获取当前图层的所有点位，点位的获取需要满足下面条件
		$$
		\begin{aligned}
		(point.x - mark_r.x) \mod intervel_b.x & =  0 \\
		(point.y - mark_r.y) \mod intervel_b.y & =  0
		\end{aligned}
		$$
		其中，$point$是获取的点位，$mark_r$是每个图层的相对mark点，$intervel_b$是下基板的晶粒间隔，这样计算的目的是筛选出上下基板对齐的晶粒点位。
	3. 按照第一部划分的区域循环，循环数为$I$
		1. 获取当前区域上基板的晶粒坐标列表，并按照start和direction重 新整理
		2. 计算当前上基板区域对应的下基板区域索引
		3. 获取当前区域的下基板晶粒坐标列表，并按照start和direction重新整理
		4. 根据四个角点获取下基板对位点的坐标
		5. 根据下基板对位点位的方位，获取上基板对位点位的坐标
		6. 整理当前区域信息，添加到当前图层中去
	4. 整理图层信息，添加到结果列表中。
	 

### version 2



## 检验测试

### 测试数据

### 测试结果

# 其他杂项整理
